pipeline {
  agent any

  environment {
    EC2_USER = 'ec2-user'
    EC2_HOST = "15.206.171.157"
    SSH_CRED = 'node-app-key'
    APP_REMOTE_DIR = '/opt/ecommerce'
    JAR_NAME = 'E-Commerce-Spring-Boot-Application/target/*.jar'
    DB_ENDPOINT = "ecommerce-db.c1qmqa4uox0f.ap-south-1.rds.amazonaws.com"
    DB_USER = credentials('db_user')
    DB_PASS = credentials('db_pass')
    HEALTH_URL = "http://${EC2_HOST}:8080/actuator/health"
  }

  stages {
    stage('Checkout') {
      steps {
        git branch: 'main', url: 'https://github.com/akashsankpal/E-Commerce-Spring-Boot-Application-on-EC2-RDS-Using-Terraform-and-Jenkins.git'
      }
    }

    stage('Build') {
      steps {
        dir('E-Commerce-Spring-Boot-Application') {
          sh 'mvn -B clean package -DskipTests=false'
        }
        archiveArtifacts artifacts: '**/target/*.jar', onlyIfSuccessful: true
      }
    }

    stage('Prepare Config') {
      steps {
        sh """
        cat > application-prod.properties <<EOF
spring.datasource.url=jdbc:mysql://${DB_ENDPOINT}:3306/ecomdb
spring.datasource.username=${DB_USER}
spring.datasource.password=${DB_PASS}
spring.profiles.active=prod
EOF
        """
      }
    }

    stage('Upload & Deploy') {
      steps {
        sshagent(credentials: [env.SSH_CRED]) {
          sh """
          ssh -o StrictHostKeyChecking=no ${EC2_USER}@${EC2_HOST} '
            sudo mkdir -p ${APP_REMOTE_DIR} &&
            sudo chown ${EC2_USER}:${EC2_USER} ${APP_REMOTE_DIR}
          '

          scp -o StrictHostKeyChecking=no ${JAR_NAME} ${EC2_USER}@${EC2_HOST}:${APP_REMOTE_DIR}/ecommerce.jar
          scp -o StrictHostKeyChecking=no application-prod.properties ${EC2_USER}@${EC2_HOST}:${APP_REMOTE_DIR}/application-prod.properties

          ssh -o StrictHostKeyChecking=no ${EC2_USER}@${EC2_HOST} '
            sudo chown ${EC2_USER}:${EC2_USER} ${APP_REMOTE_DIR}/* &&
            sudo systemctl restart ecommerce
          '
          """
        }
      }
    }

    stage('Health Check') {
      steps {
        sh 'sleep 10'
        sh "curl -f ${HEALTH_URL}"
      }
    }
  }

  post {
    success { echo "✅ Deployment successful!" }
    failure { echo "❌ Deployment failed!" }
  }
}
