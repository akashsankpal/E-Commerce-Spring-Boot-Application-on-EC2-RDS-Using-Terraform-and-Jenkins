pipeline {
  agent any

  environment {
    EC2_USER = 'ec2-user'                       // change if needed
    EC2_HOST = "15.206.171.157"        // replace with terraform output (or use Jenkins variable)
    SSH_CRED = 'node-app-key'                    // id of SSH credential in Jenkins
    APP_REMOTE_DIR = '/opt/ecommerce'
    JAR_NAME = 'target/*.jar'
    DB_ENDPOINT = "ecommerce-db.c1qmqa4uox0f.ap-south-1.rds.amazonaws.com"              // replace with terraform output or Jenkins credential
    DB_USER = credentials('db_user')            // optional: username stored as secret text; or use username directly
    DB_PASS = credentials('db_pass')            // optional: store password
    HEALTH_URL = "http://${EC2_HOST}:8080/actuator/health"
  }

  stages {
    stage('Checkout') {
      steps { checkout scm }
    }

    stage('Build') {
      steps {
        sh 'mvn -B clean package -DskipTests=false'
        archiveArtifacts artifacts: 'target/*.jar', onlyIfSuccessful: true
      }
    }

    stage('Prepare Config') {
      steps {
        // write application-prod.properties locally (Jenkins workspace)
        sh """
          cat > application-prod.properties <<EOF
          spring.datasource.url=jdbc:mysql://${DB_ENDPOINT}:3306/ecomdb
          spring.datasource.username=${DB_USER}
          spring.datasource.password=${DB_PASS}
          spring.profiles.active=prod
          EOF
        """
      }
    }

    stage('Upload artifact & config') {
      steps {
        sshagent (credentials: [env.SSH_CRED]) {
          // create remote dir and set ownership
          sh "ssh -o StrictHostKeyChecking=no ${EC2_USER}@${EC2_HOST} 'sudo mkdir -p ${APP_REMOTE_DIR} && sudo chown ${EC2_USER}:${EC2_USER} ${APP_REMOTE_DIR}'"

          // copy jar
          sh "scp -o StrictHostKeyChecking=no ${JAR_NAME} ${EC2_USER}@${EC2_HOST}:${APP_REMOTE_DIR}/ecommerce.jar"
          // copy config
          sh "scp -o StrictHostKeyChecking=no application-prod.properties ${EC2_USER}@${EC2_HOST}:${APP_REMOTE_DIR}/application-prod.properties"

          // set permissions and restart systemd
          sh "ssh -o StrictHostKeyChecking=no ${EC2_USER}@${EC2_HOST} 'sudo chown appuser:appuser ${APP_REMOTE_DIR}/ecommerce.jar ${APP_REMOTE_DIR}/application-prod.properties && sudo systemctl restart ecommerce.service'"
        }
      }
    }

    stage('Health Check') {
      steps {
        sh 'sleep 10'            // let app boot
        sh """
          set +e
          curl -f ${HEALTH_URL} || (echo 'Health check failed' && exit 1)
        """
      }
    }
  }

  post {
    success { echo "Deployed successfully" }
    failure { echo "Deployment failed" }
  }
}
